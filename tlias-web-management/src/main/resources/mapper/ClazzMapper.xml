<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itheima.tliaswebmanagement.mapper.ClazzMapper">

    <!--
        查询班级列表
        根据条件动态查询clazz表中的数据

        参数:
            name - 班级名称（模糊匹配）
            begin - 开始日期（大于等于该日期）
            end - 结束日期（小于等于该日期）

        返回值:
            List<Clazz> - 符合条件的班级对象集合
    -->
    <select id="list" resultType="com.itheima.tliaswebmanagement.pojo.Clazz">
        select c.id, c.name, c.room, c.begin_date, c.end_date, c.master_id, c.subject, c.create_time, c.update_time,
        e.name master_name,
        (case when begin_date &gt; now() then '未开班' when now() &gt; end_date then '已结课' else  '在读中' end ) status
               from clazz c left join emp e on c.master_id = e.id
        <where>
            <!-- 动态拼接查询条件 -->
            <if test="name != null">
                and c.name like concat('%',#{name},'%')
            </if>
            <if test="begin != null">
                and c.begin_date <![CDATA[>=]]> #{begin}
            </if>
            <if test="end != null">
                and c.end_date <![CDATA[<=]]> #{end}
            </if>
        </where>
    </select>

    <!--
        根据ID删除班级信息

        参数:
            id - 要删除的班级ID

        返回值:
            int - 删除影响的行数
    -->
    <delete id="deleteById">
        delete from clazz where id = #{id}
    </delete>

    <!--
        插入新的班级信息

        参数:
            name - 班级名称
            room - 教室编号
            beginDate - 开始日期
            endDate - 结束日期
            masterId - 班主任ID
            subject - 所属学科
            createTime - 创建时间
            updateTime - 更新时间

        返回值:
            int - 插入影响的行数
    -->
    <insert id="insert">
        insert into clazz(name, room, begin_date, end_date, master_id, subject, create_time, update_time)
        values(#{name}, #{room}, #{beginDate}, #{endDate}, #{masterId}, #{subject}, #{createTime}, #{updateTime})
    </insert>

    <!--
        根据ID查询班级详细信息

        参数:
            id - 班级ID

        返回值:
            Clazz - 对应的班级对象
    -->
    <select id="selectById" resultType="com.itheima.tliaswebmanagement.pojo.Clazz">
        select id, name, room, begin_date, end_date, master_id, subject, create_time, update_time from clazz where id = #{id}
    </select>

    <!--
        根据ID更新班级信息（部分字段可选更新）

        参数:
            id - 班级ID
            name - 班级名称（可为空）
            room - 教室编号（可为空）
            beginDate - 开始日期（可为空）
            endDate - 结束日期（可为空）
            masterId - 班主任ID（可为空）
            subject - 所属学科（可为空）
            updateTime - 更新时间（可为空）

        返回值:
            int - 更新影响的行数
    -->
    <update id="updateById">
        update clazz
            <set>
                <!-- 动态设置需要更新的字段 -->
                <if test="name != null">
                    name = #{name},
                </if>
                <if test="room != null">
                    room = #{room},
                </if>
                <if test="beginDate != null">
                    begin_date = #{beginDate},
                </if>
                <if test="endDate != null">
                    end_date = #{endDate},
                </if>
                <if test="masterId != null">
                    master_id = #{masterId},
                </if>
                <if test="subject != null">
                    subject = #{subject},
                </if>
                <if test="updateTime != null">
                    update_time = #{updateTime},
                </if>
            </set>
        where id = #{id}
    </update>

    <!--
        查询所有班级信息

        返回值:
            List<Clazz> - 所有班级对象集合
    -->
    <select id="selectAll" resultType="com.itheima.tliaswebmanagement.pojo.Clazz">
        select id, name, room, begin_date, end_date, master_id, subject, create_time, update_time from clazz
    </select>

    <!--
     * 查询学生数量统计信息
     *
     * @param 无参数
     * @return java.util.Map 返回包含班级名称和对应学生数量的映射集合
     *         key: 班级名称(如果班级名称为空则显示"无班级")
     *         value: 该班级的学生数量
     -->
    <!--
     * SQL逻辑说明：
     * 1. 使用right join确保所有学生都被统计，即使没有分配班级
     * 2. 当班级名称为null时，显示默认值"无班级"
     * 3. 按班级名称分组统计学生数量
     -->
    <select id="selStudentCountData" resultType="java.util.Map">
        select (case when c.name is null then '无班级' else c.name end) name, count(1) value from clazz c right join student s on c.id = s.clazz_id group by c.name
    </select>

</mapper>
